<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Proctoring – Reports</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        :root {
            --primary: #1e3c72;
            --primary-light: #2a5298;
            --secondary: #3b82f6;
            --bg: linear-gradient(135deg, #0f1e3d 0%, #1e3c72 50%, #2a5298 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --header-bg: rgba(255, 255, 255, 0.98);
            --table-header: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --table-row-hover: rgba(255, 255, 255, 0.05);
        }

        body {
            margin: 0;
            background: var(--bg);
            background-attachment: fixed;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        .header {
            padding: 25px 40px;
            background: var(--header-bg);
            border-bottom: 1px solid #e2e2e2;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header h2 {
            margin: 0;
            font-size: 26px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-area {
            display: flex;
            gap: 12px;
        }

        .search-area input {
            width: 280px;
            padding: 12px 16px;
            border: 2px solid #e0e6ff;
            border-radius: 10px;
            font-size: 14px;
            background: #f8faff;
            transition: all 0.3s ease;
        }

        .search-area input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-area button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-area button:hover {
            background: linear-gradient(135deg, #162b57 0%, #1a3a7a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 60, 114, 0.3);
        }

        .container {
            padding: 35px;
        }

        .table-section {
            margin-top: 30px;
            background: var(--card-bg);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .table-section h3 {
            font-size: 22px;
            margin-bottom: 25px;
            font-weight: 700;
            color: var(--primary);
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e6ff;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .table-section h3 i {
            color: var(--secondary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e6ff;
        }

        th {
            background: var(--table-header);
            color: white;
            font-size: 15px;
            font-weight: 600;
            padding: 18px 20px;
            text-align: left;
            border-bottom: 2px solid #1a3a7a;
        }

        td {
            padding: 18px 20px;
            font-size: 15px;
            color: #333;
            border-bottom: 1px solid #f0f0f0;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background-color: #f8faff;
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
        }

        .student-details h4 {
            margin: 0;
            font-size: 15px;
            color: #333;
            font-weight: 600;
        }

        .student-details p {
            margin: 4px 0 0;
            color: #666;
            font-size: 13px;
        }

        .exam-info {
            font-weight: 600;
            color: var(--primary);
        }

        .view-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .view-btn:hover {
            background: linear-gradient(135deg, #162b57 0%, #1a3a7a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 60, 114, 0.3);
        }

        .view-btn i {
            font-size: 16px;
        }

        /* Show More / Show Less button */
        .toggle-container {
            text-align: center;
            margin-top: 25px;
        }

        .toggle-btn {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
        }

        .toggle-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 60, 114, 0.2);
        }

        @media (max-width: 992px) {
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
                padding: 20px;
            }
            
            .search-area {
                width: 100%;
                justify-content: center;
            }
            
            .search-area input {
                width: 100%;
                max-width: 400px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
            
            .search-area {
                flex-direction: column;
            }
            
            .search-area input {
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <div class="header">
        <h2><i class="fa-solid fa-shield-halved"></i> AI Proctoring Reports</h2>

        <div class="search-area">
            <input type="text" id="searchInput" placeholder="Search by student or exam...">
            <button id="searchButton"><i class="fa-solid fa-search"></i> Search</button>
        </div>
    </div>

    <div class="container">
        <div class="table-section">
            <h3><i class="fa-solid fa-list-check"></i> Detailed AI Examination Reports</h3>

            <table>
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Class</th>
                        <th>Exam</th>
                        <th>Department</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamic rows generated via JS -->
                </tbody>
            </table>

            <!-- Show More / Show Less button container -->
            <div class="toggle-container" id="toggleContainer" style="display: none;">
                <button class="toggle-btn" id="toggleBtn">
                    <i class="fa-solid fa-chevron-down" id="toggleIcon"></i> <span id="toggleText">Show More</span>
                </button>
            </div>
        </div>
    </div>

<script>
    // Configuration
    const INITIAL_DISPLAY_COUNT = 10;
    let isFullView = false; // true = all rows shown, false = only first 10 shown
    let currentSearchTerm = '';

    async function loadReports() {
        try {
            // Fetch all reports from backend
            const res = await fetch("http://localhost:3000/api/results"); 
            const data = await res.json();

            if (!data.success) {
                alert("Failed to load reports");
                return;
            }

            const tbody = document.querySelector("table tbody");
            tbody.innerHTML = "";

            // Store all reports globally for later use (if needed)
            window.allReports = data.data;

            data.data.forEach(report => {
                const batch = report.class || "Unknown";
                const department = report.department || "Unknown";

                // ✅ Updated: use regno + exam_id for result link (admin view)
                const resultHref = `admin_result_view.html?regno=${encodeURIComponent(report.regno)}&examId=${encodeURIComponent(report.exam_id)}`;

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>
                        <div class="student-info">
                            <div class="student-avatar">
                                ${report.student_name ? report.student_name.split(" ").map(n => n[0]).join("") : "S"}
                            </div>
                            <div class="student-details">
                                <h4>${report.student_name || "Unknown"}</h4>
                                <p>ID: ${report.regno || "-"}</p>
                            </div>
                        </div>
                    </td>
                    <td>${batch}</td>
                    <td class="exam-info">${report.exam_name || "-"}</td>
                    <td>${department}</td>
                    <td>
                        <a href="${resultHref}"  class="view-btn">
                            <i class="fa-regular fa-eye"></i> View
                        </a>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Initialize view state
            isFullView = false;
            currentSearchTerm = '';
            filterAndSortRows(); // This will apply search (none) and limit to first 10

            updateStatNumbers(data.data);

        } catch (err) {
            console.error(err);
            alert("Error loading reports");
        }
    }

    // Apply search filter and limit based on current view state
    function applyVisibility() {
        const tbody = document.querySelector('table tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const searchTerm = currentSearchTerm.toLowerCase();

        let matchCount = 0; // number of rows that match search (in current order)

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const matches = text.includes(searchTerm);
            if (matches) {
                matchCount++;
                // Show this row if in full view OR it's within the first 10 matches
                if (isFullView || matchCount <= INITIAL_DISPLAY_COUNT) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            } else {
                row.style.display = 'none';
            }
        });

        // Update toggle button based on total matching rows
        updateToggleButton(matchCount);
    }

    // Sort rows and then reapply visibility
    function filterAndSortRows() {
        const tbody = document.querySelector('table tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const searchTerm = document.querySelector('.search-area input').value.toLowerCase();
        currentSearchTerm = searchTerm; // store for later use

        // Sort rows based on class and department (stable sort)
        rows.sort((a, b) => {
            const classA = a.cells[1]?.textContent.trim() || '';
            const classB = b.cells[1]?.textContent.trim() || '';
            const deptA = a.cells[3]?.textContent.trim() || '';
            const deptB = b.cells[3]?.textContent.trim() || '';
            let cmp = classA.localeCompare(classB);
            if (cmp !== 0) return cmp;
            return deptA.localeCompare(deptB);
        });

        // Reorder rows in the tbody
        rows.forEach(row => tbody.appendChild(row));

        // Apply visibility based on current search and view state
        applyVisibility();
    }

    // Update the toggle button text/icon and visibility
    function updateToggleButton(totalMatchingRows) {
        const toggleContainer = document.getElementById('toggleContainer');
        const toggleBtn = document.getElementById('toggleBtn');
        const toggleIcon = document.getElementById('toggleIcon');
        const toggleText = document.getElementById('toggleText');

        if (totalMatchingRows > INITIAL_DISPLAY_COUNT) {
            toggleContainer.style.display = 'block';
            if (isFullView) {
                toggleText.textContent = 'Show Less';
                toggleIcon.className = 'fa-solid fa-chevron-up';
            } else {
                toggleText.textContent = 'Show More';
                toggleIcon.className = 'fa-solid fa-chevron-down';
            }
        } else {
            toggleContainer.style.display = 'none';
        }
    }

    // Toggle between limited and full view
    function toggleView() {
        isFullView = !isFullView;
        // Reapply visibility with current search term
        applyVisibility();
        // The button text/icon will be updated inside applyVisibility via updateToggleButton
    }

    // Event listeners
    document.getElementById('searchButton').addEventListener('click', filterAndSortRows);
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') filterAndSortRows();
    });
    document.getElementById('toggleBtn').addEventListener('click', toggleView);

    function updateStatNumbers(reports) {
        const statTotal = document.querySelector('.card:nth-child(1) .stat-number');
        if (statTotal) statTotal.textContent = reports.length;
    }

    document.addEventListener("DOMContentLoaded", loadReports);
</script>

</body>
</html>